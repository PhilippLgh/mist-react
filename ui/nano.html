<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/buefy/dist/buefy.min.css">
    <style>
      html, body {
        padding: 0px;
        margin: 0px;
        background-color: #1E1E1E;
        overflow: hidden;
      }
      body {
        min-height: 100vh;
      }
    </style>
    <style>
      .switch input[type=checkbox]:checked+.check {
          background: #57d57e;
      }
      .switch:hover input[type=checkbox]:checked+.check {
          background: rgba(87,213, 126, .9);
      }
      .switch input[type=checkbox]:focus:checked+.check {
        box-shadow: 0 0 0.5em rgba(87,213, 126,.8);
      }

      .switch input[type=checkbox]+.check {
        background: #3e3e3e;
      }

      #app {
        padding: 10px;
      }

      .client-item {
        padding: 5px;
        display: flex;
        color: white;
      }

      .client-name {
        margin-right: 5px;
      }

      .client-name:hover {
        cursor: pointer;
        text-decoration: underline; 
      }

      .client-profile {
        color: #44a1d9;
        margin-right: 5px;
      }

      span.centered {
        display: inline-flex;
        align-items: center;
      }

      .client-state {
        color: #555;
        margin-right: 5px;
      }

      .client-version {
        font-size: .8rem;
        color: #555;
        visibility: hidden;
      }

      .client-item:hover .client-version {
        visibility: visible;
      }

      .button.client-button {
        background-color: transparent;
        border: none;
        outline: 1px solid grey;
        font-size: .70rem;
        color: #666;
      }

      .button.client-button:hover {
        outline: 1px solid #FFF;
      }

      .button.client-button:focus {
        outline: none;
        border: none;
      }

      .spacer {
        flex-grow: 1;
      }
    </style>
</head>

<body>
    <div id="app">
      <client-item v-for="client in clients" :client="client"></client-item>
    </div>

    <script src="https://unpkg.com/vue"></script>
    <!-- Full bundle -->
    <script src="https://unpkg.com/buefy/dist/buefy.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">

    <script>

        Vue.component('profile-select', {
          template: `
          <b-dropdown aria-role="list">
        <button size="is-small" class="button is-primary" slot="trigger">
            <span>Click me!</span>
            <b-icon pack="fas" icon="caret-down"></b-icon>
        </button>
        <b-dropdown-item aria-role="listitem">Action</b-dropdown-item>
        <b-dropdown-item aria-role="listitem">Another action</b-dropdown-item>
        <b-dropdown-item aria-role="listitem">Something else</b-dropdown-item>
      </b-dropdown>
          `
        })

        Vue.component('client-item', {
          props: ['client'],
          data: function() {
            return {
              clientVersion: '',
              isSwitched: false,
              state: '',
              isDownloading: false,
              downloadProgress: 0
            }
          },
          template: `
          <div>
            <div class="client-item">
              <span class="client-name centered">{{ client.displayName }}</span>
              <span class="client-profile centered">{{ client.profile }}</span>
              <span class="client-state centered">{{ state }}</span>
              <span class="client-version centered">{{ clientVersion }}</span>
              <div class="spacer"></div>
              <b-switch v-model="isSwitched" @input="handleChange($event)" size="is-small"></b-switch>
              <b-button 
                class="client-button"
                size="is-small"
                icon-pack="fas"
                icon-left="terminal"
                v-on:click="openTerminal()"
              >
              </b-button>
              <!--
              <b-button
                class="client-button" 
                size="is-small"
                icon-pack="fas"
                icon-left="cog"
                v-on:click="openSettings()"
              >
              </b-button>
              -->
            </div>
            <progress v-if="isDownloading" max="100" class="progress is-small is-primary" v-bind:value="downloadProgress"></progress>
          </div>
          `,
          methods: {
            handleSwitchedOn: async function(clientPlugin) {
              // check if downloaded version is available
              let latestBinCached = await clientPlugin.getLatestCached()
              if (!latestBinCached) {
                console.log('no client binary found --> download now')
                const latestRemote = await clientPlugin.getLatestRemote()
                // TODO handle no remote release found
                try {
                  this.state = "downloading"
                  this.isDownloading = true
                  latestBinCached = await clientPlugin.download(latestRemote, downloadProgress => {
                    console.log('download progress', downloadProgress)
                    this.downloadProgress = downloadProgress
                    this.state = `downloading ${downloadProgress}%`
                  })
                  this.isDownloading = false
                  this.state = ""
                } catch (error) {
                  console.log('error during download', error)
                  return //TODO handleDownloadError(error)
                }
              }

              this.clientVersion = latestBinCached.version
              
              console.log('cached release found --> start now')
              clientPlugin.start(latestBinCached)

              clientPlugin.on('newState', (state) => {
                console.log('new state', state)
                this.state = state
              })
            },
            handleChange: function(ev) {
              // get reference to plugin                
              const clientPlugin = window.Grid.PluginHost.getPluginByName(this.client.name)
              if (this.isSwitched) {
                this.handleSwitchedOn(clientPlugin)
              } else {
                // TODO cancel download if currently running
                if (['started', 'starting'].includes(this.state)) {
                  clientPlugin.stop()
                }
              }
            },
            openSettings: function (message) {
              // TODO open settings
            },
            openTerminal: async function (message) {
              console.log('open terminal')
              const apps = await window.Grid.AppManager.launch({
                name: 'grid-ui',
                args: {
                  scope: {
                    component: 'terminal',
                    client: 'geth'
                  }
                }
              })
            }
          }
        })

        new Vue({
          el: '#app',
          data: {
            clients: [],
            isSwitched: false
          },
          mounted: async function(){
            try {
              const plugins = window.Grid.PluginHost.getAllPlugins()
              this.clients = plugins.map(p => ({
                name: p.name,
                displayName: p.displayName,
                profile: '',
                version: ''
              }))
              console.log('plugins loaded', plugins.length)
            } catch (error) {
              console.log('error loading plugins', error)          
            }
          } 
        })
    </script>
</body>
</html>